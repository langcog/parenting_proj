---
title             : "Measuring Lay Theories of Parenting and Child Development"
shorttitle        : "Measuring Parenting Theories"
author: 
  - name          : "Emily Hembacher"
    affiliation   : "1"
    corresponding : no    # Define only one corresponding author
  - name          : "Michael C. Frank"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "450 Serra Mall, Stanford, CA 94301"
    email         : "mcfrank@stanford.edu"
affiliation:
  - id            : "1"
    institution   : "Stanford University"
author_note: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.
  Enter author note here.
abstract: |
  Enter abstract here. Each new line herein must be indented, like this line.
  
keywords          : "keywords"
wordcount         : "X"
bibliography      : ["paq.bib"]
figsintext        : yes
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : no
mask              : no
class             : "man"
output            : papaja::apa6_pdf
editor_options: 
  chunk_output_type: console
---

```{r}
knitr::opts_chunk$set(fig.width = 8, fig.height = 5, echo = FALSE, warning = FALSE, message = FALSE, cache = TRUE)
```

```{r load_packages, include = FALSE}
library(tidyverse)
library(psych)
library(langcog) 
library(ggthemes) #plot themes
library(rjson) #for json data
library(lme4) #mixed effects models
library(lmerTest) #nicer lmer output
library(tidyboot) #bootstrapped confidence intervals
library(magrittr)
library(papaja)
library(xtable)
library(gtable)
library(grid)
library(gridExtra)
library(brms)
library(viridis)
```



# Survey Construction


## Generation of items

## Revised questionnaire norming

# Survey Validation


##External Validity Study 1: Demographic Factors

```{r}
#get dataframe with subject responses
responses_demo <- read.csv("../cdm_paq.csv", header = TRUE)%>%
  filter(Finished == 1) %>%
  mutate(sid = ResponseId) %>%
  select(sid, Q1:Q28) %>%
  gather("item", "rating", Q1:Q28)
```

```{r}
#get dataframe with survey questions
questions <- read.csv("../cdm_paq.csv", header = TRUE)%>%
  filter(Status == "Response Type") %>%
  select(Q1:Q28) %>%
  gather("item", "sent", Q1:Q28)%>%  
  mutate(sent = stringr::str_replace_all(sent, "’", ""))
```

```{r}
#get dataframe with short sentences
labels_demo <-  read.csv("../analysis/sent_forms_cdm.csv")%>%
  mutate(sent = as.character(sent))
```

```{r}
responses_demo%<>%
  left_join(questions)%>%
  left_join(labels_demo)

#rescore reverse coded items
responses_demo$rating <- as.numeric(responses_demo$rating)
responses_demo$rating[responses_demo$reverse_code == 1] <- 8 -responses_demo$rating[responses_demo$reverse_code == 1]
responses_demo$rating <- responses_demo$rating - 1
```

```{r}
#get dataframe with demographic info
subinfo <- read.csv("../cdm_paq_dem.csv", header = TRUE)%>%
  filter(Finished == "True") %>%
  transmute(sid = ResponseId, ethnicity = Q25.1, parent_ed = Q26.1, parent_age = Q27.1, parent_gender = Q28.1, num_kids = Q29, oldest_kid = Q30, youngest_kid = Q32, only_kid = Q33)%>%
  mutate(parent_age_approx = parent_age,
         parent_ed_years = parent_ed)

#recode parent age to be continuous
subinfo$parent_age_approx <- recode(subinfo$parent_age_approx, "Under 18" = "18", "18 - 24" = "21", "25 - 34" = "30", "35 - 44" = "40", "45 - 54" = "50", "55 - 64" = "60", "65 - 74" = "70")
subinfo$parent_age_approx <- as.numeric(as.character(subinfo$parent_age_approx))

#recode parent ed to be continuous (num years)
subinfo$parent_ed_years <- recode(subinfo$parent_ed_years, "Less than high school" = "12", "High school graduate" = "12", "Some college" = "14", "2 year degree" = "14", "4 year degree" = "16", "Professional degree" = "19", "Doctorate" = "23")
subinfo$parent_ed_years <- as.numeric(as.character(subinfo$parent_ed_years))

subinfo$ethnicity <- as.character(subinfo$ethnicity)
subinfo$ethnicity[str_detect(subinfo$ethnicity, ",")] <- "Multiple Ethnicities"
```

```{r}
#merge questionnaire data with labels and demo info
d_demo <- responses_demo%>%
  left_join(subinfo)
```

```{r}
#create a dataframe that has mean subject scores and demographics
ss <- d_demo %>%
  group_by(sid, category) %>%
  summarise(rating = mean(rating))%>%
  left_join(subinfo)
```

```{r}
#only plot groups that have at least 20 observations
genders <- c("Male", "Female")

ethnicities <- ss%>%
  group_by(ethnicity) %>%
  filter(n() > 20)%>%
  select(ethnicity)%>%
  filter(ethnicity !="",
         ethnicity != "Other")%>%
  unique
ethnicities <- ethnicities$ethnicity

ages <- ss%>%
  group_by(parent_age) %>%
  filter(n() > 20)%>%
  select(parent_age)%>%
  unique
ages <- ages$parent_age

parent_eds <- ss%>%
  group_by(parent_ed) %>%
  filter(n() > 20)%>%
  select(parent_ed)%>%
  unique
parent_eds <- parent_eds$parent_ed

nums_kids <- ss%>%
  group_by(num_kids) %>%
  filter(n() > 20)%>%
  select(num_kids)%>%
  unique
nums_kids <- nums_kids$num_kids
```

```{r}
ms_gender <- d_demo %>% 
  filter(parent_gender %in% genders) %>%
  group_by(parent_gender, category) %>%
  tidyboot_mean(col = rating, na.rm = TRUE)
```

```{r}
p_gender <- ggplot(ms_gender, aes(category, mean, fill=parent_gender)) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
             position = position_dodge(width = .9)) + 
  xlab("PAQ Subscale") + 
  ylab("PAQ Score") +
  theme_base()+
  scale_fill_viridis(discrete = TRUE, name="Parent Gender") +
  scale_y_continuous(limits=c(0,6), breaks=c(0,2,4,6))+ 
  theme(legend.title = element_text(size=10), 
        legend.text = element_text(size=10), 
        axis.title.x=element_blank(),
        axis.text.y  = element_text(vjust=0.5, size=10),
        axis.title.y = element_text(size=12))
```

```{r}
ms_age <- d_demo %>% 
  filter(parent_age %in% ages) %>%
  group_by(parent_age, category) %>%
  tidyboot_mean(col = rating)
```

```{r}
p_age <- ggplot(ms_age, aes(category, mean, fill=parent_age)) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
             position = position_dodge(width = .9)) + 
  xlab("PAQ Subscale") + 
  ylab("PAQ Score") +
  theme_base()+
  scale_fill_viridis(discrete = TRUE, name="Parent Age") +
  scale_y_continuous(limits=c(0,6), breaks=c(0,2,4,6))+ 
  theme(legend.title = element_text(size=10), 
        legend.text = element_text(size=10), 
        axis.title.x=element_blank(),
        axis.text.y  = element_text(vjust=0.5, size=10),
        axis.title.y = element_text(size=12))
```

```{r}
ss$parent_ed <- factor(ss$parent_ed, levels = c("Less than high school","High school graduate","Some college","2 year degree","4 year degree", "Professional degree", "Doctorate"))

ms_ed <- d_demo %>% 
  group_by(parent_ed, category) %>%
  filter(parent_ed %in% parent_eds) %>%
  tidyboot_mean(col = rating)
```

```{r}
p_ed <- ggplot(ms_ed, aes(category, mean, fill=parent_ed)) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
             position = position_dodge(width = .9)) + 
  xlab("PAQ Subscale") + 
  ylab("PAQ Score") +
  theme_base()+
  scale_fill_viridis(discrete = TRUE, name="Parent Education") +
  scale_y_continuous(limits=c(0,6), breaks=c(0,2,4,6))+ 
  theme(legend.title = element_text(size=10), 
        legend.text = element_text(size=10), 
        axis.title.x=element_blank(),
        axis.text.y  = element_text(vjust=0.5, size=10),
        axis.title.y = element_text(size=12))
```

```{r}
ms_ethnic <- d_demo %>% 
  group_by(ethnicity, category) %>%
  filter(ethnicity %in% ethnicities) %>%
  tidyboot_mean(col = rating)
```

```{r}
p_ethnic <- ggplot(ms_ethnic, aes(category, mean, fill=ethnicity)) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
             position = position_dodge(width = .9)) + 
  xlab("PAQ Subscale") + 
  ylab("PAQ Score") +
  theme_base()+
  scale_fill_viridis(discrete = TRUE, name="Parent Ethnicity") +
  scale_y_continuous(limits=c(0,6), breaks=c(0,2,4,6))+ 
  theme(legend.title = element_text(size=10), 
        legend.text = element_text(size=10), 
        axis.title.x=element_blank(),
        axis.text.y  = element_text(vjust=0.5, size=10),
        axis.title.y = element_text(size=12))
```

```{r}
ms_numkids <- d_demo %>% 
  group_by(num_kids, category) %>%
  filter(num_kids %in% nums_kids) %>%
  tidyboot_mean(col = rating)
```

```{r}
p_numkids <- ggplot(ms_numkids, aes(category, mean, fill=num_kids)) +
  geom_bar(stat="identity", position = "dodge") + 
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper), 
             position = position_dodge(width = .9)) + 
  xlab("PAQ Subscale") + 
  ylab("PAQ Score") +
  theme_base()+
  scale_fill_viridis(discrete = TRUE, name="Number of Children") +
  scale_y_continuous(limits=c(0,6), breaks=c(0,2,4,6))+ 
  theme(legend.title = element_text(size=10), 
        legend.text = element_text(size=10), 
        axis.title.x=element_blank(),
        axis.text.y  = element_text(vjust=0.5, size=10),
        axis.title.y = element_text(size=12))
```

```{r, demographics,  fig.width=10, fig.height=8, fig.cap= "Demographic variability in PAQ scores. Error bars represent +/-95% CI computed by non-parametric bootstrap."}
grid.arrange(p_age, p_ed, p_ethnic, p_gender, p_numkids, nrow = 3)
```

```{r}
#make a new dataframe for regression models
d_demo_mods <- d_demo%>%
  transmute(sid = sid,
            rating = ordered(factor(rating)),
            item = short_sent,
            category = category,
            parent_age = as.numeric(parent_age_approx),
            parent_ed_years = as.numeric(parent_ed_years),
            num_kids = as.numeric(num_kids),
            ethnicity = as.factor(ethnicity),
            parent_gender = as.factor(parent_gender))

d_demo_mods$ethnicity[!d_demo_mods$ethnicity %in% ethnicities] <- NA
d_demo_mods$parent_gender[!d_demo_mods$parent_gender %in% genders] <- NA
```

```{r eval = FALSE}
#bayes ordinal logistic
#takes a long time to run
aa_demo_mod <- brm(rating ~ parent_age + ethnicity + parent_ed_years + num_kids + parent_gender +
                       (1|sid), 
     data=filter(d_demo_mods , category == "AA"),
              family=cumulative("logit"), control = list(adapt_delta = .99))

save(aa_demo_mod, file = "saved_mods/aa_demo_mod.Rdata")
```

```{r eval = FALSE}
#bayes ordinal logistic
#takes a long time to run
el_demo_mod <- brm(rating ~ parent_age + ethnicity + parent_ed_years + num_kids + parent_gender +
                       (1|sid), 
     data=filter(d_demo_mods , category == "EL"),
              family=cumulative("logit"), control = list(adapt_delta = .99))

save(el_demo_mod, file = "saved_mods/el_demo_mod.Rdata")
```

```{r eval = FALSE}
#bayes ordinal logistic
#takes a long time to run
rr_demo_mod <- brm(rating ~ parent_age + ethnicity + parent_ed_years + num_kids + parent_gender +
                       (1|sid), 
     data=filter(d_demo_mods, category == "RR"),
              family=cumulative("logit"), control = list(adapt_delta = .99))

save(rr_demo_mod, file = "saved_mods/rr_demo_mod.Rdata")
```

```{r}
#load saved ordinal logistic regression models
load ("saved_mods/aa_demo_mod.Rdata")
load ("saved_mods/el_demo_mod.Rdata")
load ("saved_mods/rr_demo_mod.Rdata")

aa_d <- summary(aa_demo_mod)
aa_demo <- data.frame(aa_d$fixed)

el_d <- summary(el_demo_mod)
el_demo <- data.frame(el_d$fixed)

rr_d <- summary(rr_demo_mod)
rr_demo <- data.frame(rr_d$fixed)
```

```{r demo_tab, results = "asis"}
factors <- c("Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "Intercept 6", "Parent Age", "Hispanic or Latino", "Multiple Ethnicities", "White", "Parent Education", "Number of children", "Male", "Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "Intercept 6", "Parent Age", "Hispanic or Latino", "Multiple Ethnicities", "White", "Parent Education", "Number of children", "Male", "Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "Intercept 6", "Parent Age", "Hispanic or Latino", "Multiple Ethnicities", "White", "Parent Education", "Number of children", "Male")

subscales <- c("AA", "", "", "", "", "", "", 
               "EL", "", "", "", "", "", "", 
               "RR", "", "", "", "", "", "")

tab_demo_lm <- aa_demo%>%
  bind_rows(el_demo)%>%
  bind_rows(rr_demo)%>%
  mutate(Factor = factors)%>%
  filter(!str_detect(Factor,"Intercept"))%>%  
  mutate(Subscale = subscales)
  
tab_demo_lm  <- tab_demo_lm [,c(8,7,1:4)]

colnames(tab_demo_lm) <- c("Subscale","Factor","Estimate", "Est. Error", "Lower 95% CI", "Upper 95% CI")

demo_tab <- xtable::xtable(tab_demo_lm, caption = "Results of separate bayesian ordinal logistic regressionsof demographic factors on PAQ scores for each subscale.")

print(demo_tab, type="latex", comment = F, table.placement = "h", hline.after = c(0, 7, 14), include.rownames=FALSE, align = c("r","l","r","r","r","r"))
```


Approaches to parenting are known to differ across cultures and groups. To better understand whether the parenting attitudes captured by our survey reflect group differences, we examined average scores on the PAQ subscales based on demographic factors. We administered the PAQ to 680 parents who were members of a local children’s museum and subsequently asked them to provide information about their gender, level of education, age, ethnicity, and the number of children they have. Figure \ref{fig:demographics} displays the distributions of demographic factors. To quantify any possible group differences, we fit Bayesian mixed effects ordinal regression models for each subscale (AA, EL, RR) with the following structure:

`agreement rating ~ age + education + ethnicity + gender + number of children + (1 | subject) + (1| item)`

## Study 2: Relation to parenting behaviors

One way of assessing the ecological validity of the PAQ is to ask whether the parenting attitudes assessed by the current measure are related to actual parenting behaviors. For example, do parents who strongly agree with items on the Early Learning subscale read to their children more often? Do parents who strongly endorse items on the Rules and Respect subscale give more time-outs? To assess this, we asked parents on mturk to rate the frequency with which they engaged in a number of parenting behaviors after having filled out the PAQ. 

```{r}
files <- dir("../production-results/parenting_behaviors_e2/")
attitudes <- data.frame()
behaviors <- data.frame()
subinfo <- data.frame()

for (f in files) {
  jf <- paste("../production-results/parenting_behaviors_e2/",f,sep="")
  jd <- fromJSON(paste(readLines(jf), collapse=""))
  
  #paq answers
  attitudes_id <- data.frame(sid = as.factor(jd$WorkerId), 
               sent = jd$answers$data$sentence[1:24],
               rating = as.numeric(jd$answers$data$rating[1:24]))
                   
  attitudes <- bind_rows(attitudes, attitudes_id)
  
  #behaviors
  behaviors_id <- data.frame(sid = as.factor(jd$WorkerId),
                sent = jd$answers$data$sentence[25:36],
                rating = as.numeric(jd$answers$data$rating[25:36]))
                          
  behaviors <- bind_rows(behaviors, behaviors_id)
  
  #demographics
  subinfo_id <- data.frame(sid = as.factor(jd$WorkerId),
                   behave_age = jd$answers$data$behaveAge,
                   children = jd$answers$data$children)
  subinfo <- bind_rows(subinfo, subinfo_id)
}

#Clean up labels.
attitudes$sent <- str_replace_all(as.character(attitudes$sent), "[â‘”“’']", "")
behaviors$sent <- str_replace_all(as.character(behaviors$sent), "[â‘”“’']", "")
```

```{r}
#Read in trial info and questionnaire labels.
labels <- read.csv("../analysis/sent_forms.csv")
labels$sent <- as.character(labels$sent)
behave <- read.csv("../analysis/behaviors_e2.csv")
```

```{r}
dq <- attitudes %>%
  left_join(labels)%>%
  mutate(category_paq = category)%>%
  select(-category)

db <- behaviors%>%
  left_join(behave)%>%
  left_join(subinfo)%>%
  filter(behave_age != "older")%>%
  mutate(category_bev = category)%>%
  select(-category)

#remove items that parents marked as "my child is too young"
db$rating[db$rating == 0] <- NA

#rescore reverse coded items
dq$rating <- as.numeric(dq$rating)
dq$rating[dq$reverse_code == 1] <- 6 - dq$rating[dq$reverse_code == 1]
```

```{r}
#Get means by category.
atts <- dq %>%
  group_by(sid, category_paq) %>% 
  summarise(rating_paq = mean(rating))

bevs <- db %>%
  group_by(sid, category_bev) %>% 
  summarise(rating_bev = mean(rating))

all <- atts %>%
  left_join(bevs)%>%
  left_join(subinfo)%>%
  filter(!children == "0")
```

```{r}
#Recode variables for plotting.
bev <- behaviors %>%
  left_join(behave)%>%
  filter(rating != 0)%>%
  group_by(category)

bev$rating[bev$rating=="1"] <- "Never"
bev$rating[bev$rating=="2"] <- "Almost never"
bev$rating[bev$rating=="3"] <- "Occasionally"
bev$rating[bev$rating=="4"] <- "Once or twice per week"
bev$rating[bev$rating=="5"] <- "Most days"
bev$rating[bev$rating=="6"] <- "Multiple times ever day"

bev$rating <- factor(bev$rating, levels = c("My child is too young", "Never", "Almost never","Occasionally","Once or twice per week","Most days","Multiple times every day"))


bev$short_sent <- factor(bev$short_sent, levels = c("read","practice numbers and letters","make observations", "educational programming","talk about feelings","spend time cuddling","sleep in the same bed","hug and kiss","talk sternly","give time out or punishments","talk about setting limits","help with chores"))

subinfo$behave_age[subinfo$behave_age == "0-6"] <- "0-6 months"
subinfo$behave_age[subinfo$behave_age == "7-12"] <- "7-12 months"

subinfo$behave_age <- factor(subinfo$behave_age, levels = c("0-6 months", "7-12 months", "1-1.5","1.5-2","2-2.5","2.5-3","3-3.5","3.5-4", "4-4.5","4.5-5", "older"))
```

```{r, behave_freq, echo = FALSE, fig.width=10, fig.height=6, fig.cap= "Frequencies of different parenting activities reported by parents."}
ggplot(filter(bev, !is.na(rating)), aes(short_sent, fill = rating, shape = category)) + 
  geom_bar(position = "fill")+
  xlab("Behavior") + 
  ylab("Proportion responding") +
  theme_base()+
  scale_fill_viridis(name="Frequency", discrete = TRUE, breaks=c("Most days","Once or twice per week","Occasionally", "Almost never", "Never"))+
  coord_flip()+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y = element_text(size = 12),
        legend.position="bottom",
        legend.text = element_text(size = 14),
        legend.title=element_blank()) 
```

```{r}
#descriptive labels for behavior categories
all$category_bev <- factor(all$category_bev,
levels = c("AA", "EL", "RR"),
labels = c("AA Behaviors", "EL Behaviors", "RR Behaviors"))
```

```{r behave_paq, fig.cap= "Relations between PAQ scores (Affection and Attachment, Early Learning, and Rules and Respect) and the frequency of parenting behaviors divided into the same categories."}
ggplot(filter(all, !is.na(category_bev)), aes(x= rating_bev, y = rating_paq, colour = category_paq)) +
  geom_jitter(aes(color = category_paq), height = .02, width = 0, alpha= .3) +
  geom_smooth(method="lm", se=TRUE) +
  facet_grid(~category_bev) + 
  xlab("Frequency of behavior") + 
  ylab("PAQ score") + 
  labs(colour="PAQ subscale")+
  theme_base()+
  scale_color_viridis(discrete = TRUE) +
  scale_y_continuous(limits=c(0,6), breaks=c(0,2,4,6))
```

```{r}
#Set up dataframes for analyses.
d <- db %>%
  left_join(atts)%>%
  left_join(subinfo)%>%
  filter(!is.na(rating))%>%
  filter(children != 0)%>%
  filter(behave_age != "older")%>%
  filter(behave_age != "")%>%
  select(sid, short_sent, rating, category_paq, category_bev, rating_paq, behave_age)%>%
  spread(category_paq, rating_paq)

d$behave_age <- as.character(d$behave_age)

d$behave_age[d$behave_age == "0-6 months"] <- 1
d$behave_age[d$behave_age == "7-12 months"] <- 7
d$behave_age[d$behave_age == "1-1.5"] <- 13
d$behave_age[d$behave_age == "1.5-2"] <- 19 
d$behave_age[d$behave_age == "2-2.5"] <- 25
d$behave_age[d$behave_age == "2.5-3"] <- 31
d$behave_age[d$behave_age == "3-3.5"] <- 37
d$behave_age[d$behave_age == "3.5-4"] <- 43
d$behave_age[d$behave_age == "4-4.5"] <- 49
d$behave_age[d$behave_age == "4.5-5"] <- 55

d$behave_age <- as.numeric(d$behave_age)

d<- d%>%
  mutate(child_age = behave_age)%>%
  select(-behave_age)%>%
  mutate(rating_bin = rating)

d$rating_bin[d$rating %in% 1:4] <- "low"
d$rating_bin[d$rating %in% 5:6] <- "high"

d_aa <- d%>%
  filter(category_bev == "AA")%>%
  filter(!is.na(rating), !is.na(rating_bin))

d_el <- d%>%
  filter(category_bev == "EL")%>%
  filter(!is.na(rating),!is.na(rating_bin))

d_rr <- d%>%
  filter(category_bev == "RR")%>%
  filter(!is.na(rating),!is.na(rating_bin))

d_aa$rating_bin <- as.factor(d_aa$rating_bin)
d_el$rating_bin <- as.factor(d_el$rating_bin)
d_rr$rating_bin <- as.factor(d_rr$rating_bin)
```

```{r}
d$rating <- factor(d$rating,
levels = c(1, 2, 3, 4, 5, 6),
labels = c("1-never", "2-almost-never", "3-occasionally", "4-once-or-twice-per-week", "5-most-days", "6-multiple-times-every-day"))
```

```{r eval = FALSE}
d_aa%<>%
  mutate(rating = ordered(as.factor(rating)))

aa_behave_mod <- brm(rating ~ AA + RR + EL + child_age + 
              (1|sid) + 
              (1|short_sent), data=filter(d_aa, !is.na(rating)),
              family=cumulative("logit"), control = list(adapt_delta = .99))

save(aa_behave_mod, file = "saved_mods/aa_mod_behave.Rdata")
```

```{r eval = FALSE}
d_el%<>%
  mutate(rating = ordered(as.factor(rating)))

el_behave_mod <- brm(rating ~ AA + RR + EL + child_age + 
              (1|sid) + 
              (1|short_sent), data=filter(d_el, !is.na(rating)),
              family=cumulative("logit"), control = list(adapt_delta = .99))

save(el_behave_mod, file = "saved_mods/el_mod_behave.Rdata")
```

```{r eval = FALSE}
d_rr%<>%
  mutate(rating = ordered(as.factor(rating)))

rr_behave_mod <- brm(rating ~ AA + RR + EL + child_age + 
              (1|sid) + 
              (1|short_sent), data=filter(d_rr, !is.na(rating)),
              family=cumulative("logit"), control = list(adapt_delta = .99))

save(rr_behave_mod, file = "saved_mods/rr_mod_behave.Rdata")
```

```{r}
#load saved ordinal logistic regression models
load ("saved_mods/aa_mod_behave.Rdata")
load ("saved_mods/el_mod_behave.Rdata")
load ("saved_mods/rr_mod_behave.Rdata")

aa_b <- summary(aa_behave_mod)
aa_behave <- data.frame(aa_b$fixed)

el_b <- summary(el_behave_mod)
el_behave <- data.frame(el_b$fixed)

rr_b <- summary(rr_behave_mod)
rr_behave <- data.frame(rr_b$fixed)
```

```{r behave_tab, results = "asis"}
factors <- c("Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "AA PAQ score", "RR PAQ score", "EL PAQ score", "Child Age","Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "AA PAQ score", "RR PAQ score", "EL PAQ score", "Child Age","Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "AA PAQ score", "RR PAQ score", "EL PAQ score", "Child Age")

behaviors <- c("AA", "", "", "", 
               "EL", "", "", "", 
               "RR", "", "", "")

tab_behave_lm <- aa_behave%>%
  bind_rows(el_behave)%>%
  bind_rows(rr_behave)%>%
  mutate(Factor = factors)%>%
  filter(!str_detect(Factor,"Intercept"))%>%  
  mutate(`Behavior Category` = behaviors)
  
tab_behave_lm  <- tab_behave_lm [,c(8,7,1:4)]

colnames(tab_demo_lm) <- c("Subscale","Factor","Estimate", "Est. Error", "Lower 95% CI", "Upper 95% CI")

behave_tab <- xtable::xtable(tab_behave_lm, caption = "Results of separate bayesian ordinal logistic regressions of PAQ scores and child age on frequency of parenting behaviors in Affection and Attachment (AA), Early Learning (EL), and Rules and Respect (RR) categories.")

print(behave_tab, type="latex", comment = F, table.placement = "h", hline.after = c(0, 4, 8), include.rownames=FALSE, align = c("r","l","r","r","r","r"))
```

## Study 3: Uptake of new information about parenting and child development

Parents’ existing lay theories about parenting and child development may be an important consideration for crafting interventions on parenting behaviors. There have been frequent efforts to intervene on parenting behaviors, for example, public service announcements telling parents to read to their children; courses aimed at helping fathers engage with their children; messages aimed at encouraging parents and teachers to give children opportunities for free play. There is evidence that existing lay theories can interact in surprising ways with this type of messaging in other domains. How do parents’ lay theories impact how they uptake new information?

```{r}
files <- dir("../production-results/uptake_e4/")
answers <- data.frame()
attitudes <- data.frame()
subinfo <- data.frame()

for (f in files) {
  jf <- paste("../production-results/uptake_e4/",f,sep="")
  jd <- fromJSON(paste(readLines(jf), collapse=""))

  #uptake responses
  answers_id <- data.frame(
    answer= jd$answers$data$answer,
    item = jd$answers$data$item[jd$answers$data$trial_type =="uptake"],
    workerid = jd$WorkerId)
  
  answers <- bind_rows(answers, answers_id)
  
  attitudes_id <- data.frame(workerid = jd$WorkerId, 
                   sent = jd$answers$data$sentence[jd$answers$data$trial_type=="attitudes"],
                   rating = as.numeric(jd$answers$data$rating[jd$answers$data$trial_type=="attitudes"])) 
                   
  attitudes <- bind_rows(attitudes, attitudes_id)
  
  #questionnaire and demo
  subinfo_id <- data.frame(workerid = jd$WorkerId, 
                   children = jd$answers$data$children,
                   language = jd$answers$data$homelang,
                   ses = jd$answers$data$ladder,
                   gender = jd$answers$data$gender,
                   age = jd$answers$data$age,
                   education = jd$answers$data$education,
                   ethnicity = jd$answers$data$ethnicity,
                   race = as.character(jd$answers$data$race[1]),
                   rt_exp1 = jd$answers$data$target1_rt,
                   rt_exp2 = jd$answers$data$target2_rt,
                   rt_con1 = jd$answers$data$control1_rt,
                   rt_con2 = jd$answers$data$control2_rt)
  subinfo <- bind_rows(subinfo, subinfo_id)
}
```

```{r}
#Read in trial info and questionnaire labels.
labels <- read.csv("../analysis/sent_forms_uptake_e4.csv")
labels$sent <- as.character(labels$sent)

answer_key <- read.csv("../analysis/uptake_key_e4.csv")
```

```{r}
#Clean up labels.
attitudes$sent <- stringr::str_replace_all(as.character(attitudes$sent), "[â‘”“’']", "")
```

```{r}
#Questionnaire attitude means.
dq <- attitudes %>%
  left_join(labels) 

dq$rating[dq$reverse_code == 1] <- 6 - dq$rating[dq$reverse_code == 1]

atts <- dq %>%
  group_by(workerid, category) %>% 
  summarise(rating = mean(rating))
```

```{r}
#Setting up exclusion based on reading time. Exclude for less than 15s. 
exclusions <- as_tibble(subinfo) %>%
  select(workerid, starts_with("rt")) %>%
  gather(article, rt, rt_exp1, rt_exp2, rt_con1, rt_con2) %>%
  mutate(article = stringr::str_replace(stringr::str_replace(stringr::str_replace(article,"rt_", ""), "exp", "e"), "con","c"),
         exclude = rt <15)
```

`r signif(mean(exclusions$exclude*100), digits = 2)`% of the data is excluded due to reading time exclusion.

```{r}
#Get accuracy data. 
answers$answer <- as.character(answers$answer)
answer_key$answer_cor <- as.character(answer_key$answer_cor)

uptake <- answers %>%
  left_join(answer_key) %>%
  mutate(acc = (answer == answer_cor),
         sid = workerid) %>%
  select(sid, item, acc, q_type, article) %>%
  left_join(exclusions) %>%
  filter(!exclude)

mss <- uptake %>%
  group_by(workerid, q_type) %>% 
  summarise(acc = mean(acc))

ms <- mss %>%
  group_by(q_type) %>%
  multi_boot_standard(col = "acc")
```

```{r}
mss_wide <- spread(mss, q_type, acc) %>%
  filter(!is.na(con) & !is.na(exp))

t_acc_q_type <- t.test(mss_wide$con, mss_wide$exp, paired=TRUE)
```

The average accuracy for control questions was `r signif(ms$mean[ms$q_type == "con"], digits = 2)`(CI = `r signif(ms$ci_lower[ms$q_type == "con"], digits = 2)` - `r signif(ms$ci_upper[ms$q_type == "con"], digits = 2)`) and the average accuracy for experimenter questions was `r signif(ms$mean[ms$q_type == "exp"], digits = 2)`(CI = `r signif(ms$ci_lower[ms$q_type == "con"], digits = 2)` - `r signif(ms$ci_upper[ms$q_type == "exp"], digits = 2)`). There was no significant difference in accuracy between conditions, t = `r t_acc_q_type$statistic`, p = `r t_acc_q_type$p.value`.

```{r}
d <- mss %>%
  left_join(atts) %>%
  left_join(subinfo) %>%
  mutate(q_type = fct_recode(q_type, "Control" = "con", "Experimental" = "exp"))
```

```{r uptake, fig.cap= "Relations between PAQ scores (Affection and Attachment, Early Learning, and Rules and Respect) and the uptake of information in experimental (child development-related) and control articles."}
ggplot(d, aes(x = rating, y = acc, colour = q_type)) +
 geom_jitter(height = .02, width = 0, alpha= .3) +
  geom_smooth(method="lm") + 
  facet_grid(.~category) + 
  ylab("Accuracy") +
  xlab("PAQ Rating") + 
  theme(legend.position = "bottom",
        legend.title = element_text(size=16), 
        legend.text = element_text(size=14), 
        axis.text.x  = element_text(vjust=0.5, size=14),
        axis.title.x = element_text(size=16), 
        axis.text.y  = element_text(vjust=0.5, size=14),
        axis.title.y = element_text(size=16),
        strip.text = element_text(size=14))+
  theme_base()+
  scale_color_viridis(name="Condition", discrete = TRUE) 
```



```{r}
#Set up a dataframe for analysis with exclusions.
d_reg <- atts %>%
  left_join(uptake)%>%
  group_by(workerid, category, acc, q_type, item, article)%>%
  summarise(rating = mean(rating))%>%
  spread(category, rating)

d_reg_excl <- d_reg %>%
  left_join(exclusions) %>%
  filter(!exclude)
```

```{r eval = FALSE}
uptake_mod <- brm(acc ~ q_type * AA +  
                q_type * RR + 
                q_type * EL +
                (q_type | workerid) +
                (1 | item), 
              data = d_reg_excl,
              family = bernoulli())

save(uptake_mod, file ="saved_mods/uptake_mod.Rmd")
```

```{r}
#load saved ordinal logistic regression models
load ("saved_mods/uptake_mod.Rdata")

up <- summary(uptake_mod)
uptake <- data.frame(up$fixed)
```

```{r behave_tab, results = "asis"}
factors <- c("Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "AA PAQ score", "RR PAQ score", "EL PAQ score", "Child Age","Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "AA PAQ score", "RR PAQ score", "EL PAQ score", "Child Age","Intercept 1", "Intercept 2", "Intercept 3", "Intercept 4", "Intercept 5", "AA PAQ score", "RR PAQ score", "EL PAQ score", "Child Age")

behaviors <- c("AA", "", "", "", 
               "EL", "", "", "", 
               "RR", "", "", "")

tab_behave_lm <- aa_behave%>%
  bind_rows(el_behave)%>%
  bind_rows(rr_behave)%>%
  mutate(Factor = factors)%>%
  filter(!str_detect(Factor,"Intercept"))%>%  
  mutate(`Behavior Category` = behaviors)
  
tab_behave_lm  <- tab_behave_lm [,c(8,7,1:4)]

colnames(tab_demo_lm) <- c("Subscale","Factor","Estimate", "Est. Error", "Lower 95% CI", "Upper 95% CI")

behave_tab <- xtable::xtable(tab_behave_lm, caption = "Results of separate bayesian ordinal logistic regressions of PAQ scores and child age on frequency of parenting behaviors in Affection and Attachment (AA), Early Learning (EL), and Rules and Respect (RR) categories.")

print(behave_tab, type="latex", comment = F, table.placement = "h", hline.after = c(0, 4, 8), include.rownames=FALSE, align = c("r","l","r","r","r","r"))
```

\newpage

# References
```{r create_r-references}
r_refs(file = "r-references.bib")
```

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup
