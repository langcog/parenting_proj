---
title: "Parenting Project Attitudes Questionnaire Experiment 2"
author: "Emily & Mike"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    number_sections: true
---

<style type="text/css">
body, td {
   font-size: 14px;
}
code {
  font-size: 11px;
}
pre {
  font-size: 11px;
}
</style>

Data analysis of basic parenting values/attitudes survey, version 2.

# Data preprocessing

Preliminaries.

```{r echo=FALSE}
rm(list=ls())
knitr::opts_chunk$set(fig.width=8, fig.height=5, 
                      echo=TRUE, warning=FALSE, message=FALSE, cache=TRUE)
suppressPackageStartupMessages(c("dplyr","langcog","tidyr","ggplot2","lme4"))
library(langcog)
library(dplyr)
library(ggplot2)
library(rjson)
library(stringr)
library(tidyr)
theme_set(theme_bw())
```

Read in files and consolidate to the same directory. 

```{r}
files <- dir("../production-results/e2/")
d.raw <- data.frame()

for (f in files) {
  jf <- paste("../production-results/e2/",f,sep="")
  jd <- fromJSON(paste(readLines(jf), collapse=""))
  
  # clean up instruction trial
  sent <- jd$answers$data$sentence
  rating <- as.numeric(jd$answers$data$rating)
  trial_type <- jd$answer$data$trial_type
  sent <- sent[trial_type != "2afc_instructions"]
  trial_type <- trial_type[trial_type != "2afc_instructions"]
  
  id <- data.frame(workerid = jd$WorkerId, 
                   sent = sent,
                   rating = rating,
                   children = jd$answers$data$children,
                   language = jd$answer$data$homelang,
                   trial_type = trial_type,
                   ses = jd$answer$data$ladder)
  d.raw <- bind_rows(d.raw, id)
}
```

Map on question short forms so that we can use these instead. 

```{r}
labels <- read.csv("sent_forms_e2.csv")
labels$sent <- as.character(labels$sent)
d.raw$sent <- as.character(d.raw$sent)
d.raw$sent <- str_replace_all(d.raw$sent, "'", "")
d.raw$sent <- str_replace_all(d.raw$sent, "’", "")
d.raw$sent <- str_replace_all(d.raw$sent, "“", "")
d.raw$sent <- str_replace_all(d.raw$sent, "”", "")
d.raw$sent <- str_replace_all(d.raw$sent, "‘", "")
d.raw$sent <- str_replace_all(d.raw$sent, "â", "'")

d <- left_join(d.raw, labels) %>%
  mutate(children = grepl("yes", children, ignore.case=TRUE))
```

Note children question is broken.

# Basic analyses

Now look at mean ratings across sentences.

```{r}
ms <- d %>%
  group_by(category, instrument, short_sent) %>%
  multi_boot_standard(col = "rating") %>%
  arrange(instrument, category, desc(mean)) 

ms$short_sent_ord <- factor(ms$short_sent, 
                             levels = ms$short_sent)
```

First plot attitude. 

```{r}
qplot(short_sent_ord, mean, col = category,
      ymin = ci_lower, ymax = ci_upper, 
      geom = "pointrange",
      data = filter(ms, instrument == "attitudes")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  xlab("") + 
  ylab("Mean Rating") + 
  ylim(c(1,7)) + 
  scale_colour_solarized()
```

Knowledge

```{r}
qplot(short_sent_ord, mean, col = category,
      ymin = ci_lower, ymax = ci_upper, 
      geom = "pointrange",
      data = filter(ms, instrument == "knowledge")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  xlab("") + 
  ylab("Mean Rating") + 
  ylim(c(0,1)) + 
  scale_colour_solarized()
```

# Scale reliability

[Useful chapter here](http://psych.wfu.edu/furr/716/Furr%20SC%26P%20Ch%202.pdf)

## Full survey 

Let's start by looking at the internal consistency of the full survey.

```{r}
library(psych)
wide.all <- d %>% 
  select(workerid, short_sent, rating) %>% 
  spread(short_sent, rating)
alpha.mat <- as.matrix(select(wide.all, -workerid))
alpha(x = alpha.mat)
```

Base $\alpha$ = .78, compared to .75 in e1. So removing/adding items helped a bit. 

Now accounting for reverse coding:

```{r}
alpha(x = alpha.mat, 
      keys = labels$short_sent[labels$reverse_code==1])
```

$\alpha = .53$,which is not so great.

Automatic reverse coding yields $\alpha = .81$, which is better than our coding, and a little bit lower than it was in e1 (.85)

```{r}
alpha(x = alpha.mat, 
      check.keys = TRUE)
```

So now let's do this for the sub-surveys, where these issues are maybe bit clearer.

## Attitudes

First the attitudes items. 

```{r}
library(psych)
wide.attitudes <- d %>% 
  filter(instrument == "attitudes") %>%
  select(workerid, short_sent, rating) %>% 
  spread(short_sent, rating)
alpha.mat <- as.matrix(select(wide.attitudes, -workerid))
alpha(x = alpha.mat)
```

This time $\alpha = .81$ for the attitudes scale, much higher than e1 (.55).


## Knowledge

Now the knowledge items. These are in fact reverse-coded.

```{r}
library(psych)
wide.knowledge <- d %>% 
  filter(instrument == "knowledge") %>%
  select(workerid, short_sent, rating) %>% 
  spread(short_sent, rating)
alpha.mat <- as.matrix(select(wide.knowledge, -workerid))
alpha(x = alpha.mat, 
      keys = labels$short_sent[labels$reverse_code == 1 & 
                                 labels$instrument == "knowledge"])
```

So $\alpha = .59$ for these items, compared to .71 for e1. The only difference is the removal of three items that were negatively correlated with the scale during e1 (`read all words`, `no vocab bad in school`, and `tv conversation` ). Not sure if it is normal to see such variability across samples.

# Principal components analysis

Next, let's look at a principal components analysis for the data. This approach tries to understand underlying orthogonal dimensions of variability.

## All items

Explore using PCA to group items. 

I removed the PCA analysis across scales because there were more variables than participants which was causing errors.

```{r}
#pcs <- princomp(x= select(wide.all, -workerid))
#plot(pcs)
```

```{r}
#biplot(pcs)
```

## Attitude items

First the attitude items. 

```{r}
row.names(wide.attitudes) <- wide.attitudes$workerid
pcs <- princomp(x = select(wide.attitudes, -workerid))
plot(pcs)
```


Let's try to plot the items by hand for more detail. 

```{r}
pc.items <- data.frame(pc1 = pcs$loadings[,1],
                      pc2 = pcs$loadings[,2],
                      pc3 = pcs$loadings[,3],
                      short_sent = row.names(pcs$loadings)) %>%
  left_join(labels)

qplot(pc1, pc2, col = category,
      label = short_sent, hjust = 1,
      geom = c("text","point"),
      data = pc.items) + 
  scale_colour_solarized() + 
  xlim(-.15,.35)
```



```{r}
subinfo <- d %>% 
  group_by(workerid) %>%
  summarise(children = children[1])

pc.inds <- data.frame(pc1 = as.numeric(pcs$scores[,1]),
                      pc2 = as.numeric(pcs$scores[,2]),
                      pc3 = as.numeric(pcs$scores[,3]),
                      workerid = row.names(pcs$scores)) %>%
  left_join(subinfo)
                      
qplot(pc1, pc2, col = children,
      hjust = 1,
      data = pc.inds) + 
  scale_colour_solarized()
```


## Knowledge items

 

```{r}
wide.knowledge <- d %>% 
  filter(instrument == "knowledge") %>%
  mutate(rating = ifelse(reverse_code == 1, 7 - rating, rating)) %>%
  select(workerid, short_sent, rating) %>% 
  spread(short_sent, rating)

pcs <- princomp(x= select(wide.knowledge, -workerid))
plot(pcs)
```

The variance for the components are really small compared to the attitudes scale, and compared to the knowledge scale during e1. 

```{r}
pc.data <- data.frame(pc1 = pcs$loadings[,1],
                      pc2 = pcs$loadings[,2],
                      pc3 = pcs$loadings[,3],
                      short_sent = row.names(pcs$loadings)) %>%
  left_join(labels)

qplot(pc1, pc2, col = category,
      label = short_sent, hjust = 1,
      geom = c("text","point"),
      data = pc.data) + 
  xlim(-.7,.3) +
  scale_colour_solarized()
```

Kind of interesting- seems like principle component 1 might relate to whether or not parents believe they have a critical role in their child's development (e.g., school responsibility vs. words predict academic)..

# Factor analysis

```{r}
kf <- factanal(x= select(wide.knowledge, -workerid), factors = 3)

print(kf, digits=2, cutoff=.3, sort=TRUE)

# plot factor 1 by factor 2 
loadkf <- kf$loadings[,1:2] 
plot(loadkf,type="n") # set up plot 
text(loadkf,labels=names(wide.knowledge),cex=.7) # add variable names

af <- factanal(x= select(wide.attitudes, -workerid), factors = 4)

print(af, digits=2, cutoff=.3, sort=TRUE)

# plot factor 1 by factor 2 
loadaf <- af$loadings[,1:2] 
plot(loadkf,type="n") # set up plot 
text(loadkf,labels=names(wide.attitudes),cex=.7) # add variable names```

# Conclusions


